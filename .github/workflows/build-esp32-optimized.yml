name: Build ESP32 MicroPython (Optimized)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      board:
        description: 'Board to build (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - ESP32_GENERIC
          - ESP32_GENERIC_S2
          - ESP32_GENERIC_S3
          - ESP32_GENERIC_C3
          - ESP32_GENERIC_C6

env:
  IDF_PATH: /opt/esp/idf
  IDF_TOOLS_PATH: /opt/esp

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        board: ${{ github.event.inputs.board && fromJson(format('["{0}"]', github.event.inputs.board)) || fromJson('["ESP32_GENERIC", "ESP32_GENERIC_S2", "ESP32_GENERIC_S3", "ESP32_GENERIC_C3", "ESP32_GENERIC_C6"]') }}
    
    steps:
    - name: Checkout MicroPython
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    # ä½¿ç”¨ç¼“å­˜åŠ é€Ÿæž„å»º
    - name: Cache ESP-IDF
      id: cache-idf
      uses: actions/cache@v4
      with:
        path: |
          /opt/esp/idf
          /opt/esp/tools
        key: esp-idf-v5.4.1-${{ runner.os }}
        restore-keys: |
          esp-idf-v5.4.1-
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          pip-${{ runner.os }}-
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git wget curl libffi-dev libssl-dev \
          python3 python3-pip python3-venv \
          cmake ninja-build ccache \
          flex bison gperf \
          libusb-1.0-0-dev
    
    - name: Setup ESP-IDF v5.4.1
      if: steps.cache-idf.outputs.cache-hit != 'true'
      run: |
        sudo mkdir -p /opt/esp
        sudo chown $USER:$USER /opt/esp
        cd /opt/esp
        
        # å…‹éš†ESP-IDF v5.4.1
        git clone --depth 1 --branch v5.4.1 --recursive https://github.com/espressif/esp-idf.git idf
        
        cd idf
        # å®‰è£…å·¥å…·é“¾
        ./install.sh esp32,esp32s2,esp32s3,esp32c3,esp32c6,esp32h2
    
    - name: Setup ESP-IDF environment
      run: |
        cd /opt/esp/idf
        source export.sh
        echo "PATH=$PATH" >> $GITHUB_ENV
        echo "IDF_PATH=/opt/esp/idf" >> $GITHUB_ENV
        echo "IDF_TOOLS_PATH=/opt/esp" >> $GITHUB_ENV
        # æ·»åŠ æ‰€æœ‰å¿…è¦çš„çŽ¯å¢ƒå˜é‡
        env | grep -E "(IDF_|ESP|OPENOCD|XTENSA|RISCV)" >> $GITHUB_ENV
    
    - name: Build mpy-cross
      run: |
        cd mpy-cross
        make -j$(nproc)
    
    - name: Build ESP32 Firmware
      run: |
        source /opt/esp/idf/export.sh
        cd ports/esp32
        
        # æ¸…ç†ä¹‹å‰çš„æž„å»º
        make BOARD=${{ matrix.board }} clean || true
        
        # æž„å»ºå›ºä»¶
        echo "Building firmware for ${{ matrix.board }}"
        make BOARD=${{ matrix.board }} -j$(nproc)
        
        # éªŒè¯æž„å»ºæ–‡ä»¶
        ls -la build-${{ matrix.board }}/
        
        # åˆ›å»ºæž„å»ºä¿¡æ¯
        echo "=== Build Information ===" > build-${{ matrix.board }}/build-info.txt
        echo "Board: ${{ matrix.board }}" >> build-${{ matrix.board }}/build-info.txt
        echo "Date: $(date -u)" >> build-${{ matrix.board }}/build-info.txt
        echo "Commit: $(git rev-parse HEAD)" >> build-${{ matrix.board }}/build-info.txt
        echo "ESP-IDF: v5.4.1" >> build-${{ matrix.board }}/build-info.txt
        echo "Python: $(python3 --version)" >> build-${{ matrix.board }}/build-info.txt
        echo "Build host: $(hostname)" >> build-${{ matrix.board }}/build-info.txt
        echo "=========================" >> build-${{ matrix.board }}/build-info.txt
    
    - name: Prepare artifacts
      run: |
        cd ports/esp32
        BUILD_DIR="build-${{ matrix.board }}"
        ARTIFACT_DIR="artifacts-${{ matrix.board }}"
        
        mkdir -p "$ARTIFACT_DIR"
        
        # å¤åˆ¶ä¸»è¦æ–‡ä»¶
        cp "$BUILD_DIR/firmware.bin" "$ARTIFACT_DIR/" 2>/dev/null || echo "firmware.bin not found"
        cp "$BUILD_DIR/bootloader/bootloader.bin" "$ARTIFACT_DIR/" 2>/dev/null || echo "bootloader.bin not found"
        cp "$BUILD_DIR/partition_table/partition-table.bin" "$ARTIFACT_DIR/" 2>/dev/null || echo "partition-table.bin not found"
        cp "$BUILD_DIR/micropython.elf" "$ARTIFACT_DIR/" 2>/dev/null || echo "micropython.elf not found"
        cp "$BUILD_DIR/build-info.txt" "$ARTIFACT_DIR/"
        
        # åˆ›å»ºçƒ§å½•è„šæœ¬
        cat > "$ARTIFACT_DIR/flash.sh" << 'EOF'
#!/bin/bash
# ESP32 MicroPython çƒ§å½•è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: ./flash.sh [ç«¯å£] [æ³¢ç‰¹çŽ‡]
# ä¾‹å¦‚: ./flash.sh /dev/ttyUSB0 460800

PORT=${1:-/dev/ttyUSB0}
BAUD=${2:-460800}

echo "çƒ§å½•ESP32 MicroPythonå›ºä»¶..."
echo "ç«¯å£: $PORT"
echo "æ³¢ç‰¹çŽ‡: $BAUD"
echo "å¼€å‘æ¿: ${{ matrix.board }}"

if ! command -v esptool.py &> /dev/null; then
    echo "é”™è¯¯: esptool.py æœªå®‰è£…"
    echo "è¯·è¿è¡Œ: pip install esptool"
    exit 1
fi

echo "æ“¦é™¤flash..."
esptool.py --chip esp32 --port "$PORT" erase_flash

echo "çƒ§å½•å›ºä»¶..."
if [ -f "firmware.bin" ]; then
    esptool.py --chip esp32 --port "$PORT" --baud "$BAUD" write_flash -z 0x1000 firmware.bin
else
    echo "åˆ†æ®µçƒ§å½•..."
    esptool.py --chip esp32 --port "$PORT" --baud "$BAUD" write_flash \
        0x1000 bootloader.bin \
        0x8000 partition-table.bin \
        0x10000 micropython.bin
fi

echo "çƒ§å½•å®Œæˆ!"
echo "çŽ°åœ¨å¯ä»¥ä½¿ç”¨ä¸²å£å·¥å…·è¿žæŽ¥ESP32 (115200æ³¢ç‰¹çŽ‡)"
EOF
        chmod +x "$ARTIFACT_DIR/flash.sh"
        
        # åˆ›å»ºREADME
        cat > "$ARTIFACT_DIR/README.md" << EOF
# MicroPython ESP32 å›ºä»¶

## å¼€å‘æ¿ä¿¡æ¯
- **å¼€å‘æ¿**: ${{ matrix.board }}
- **æž„å»ºæ—¥æœŸ**: $(date -u)
- **ESP-IDFç‰ˆæœ¬**: v5.4.1
- **æäº¤**: $(git rev-parse HEAD)

## æ–‡ä»¶è¯´æ˜Ž
- \`firmware.bin\` - å®Œæ•´å›ºä»¶æ–‡ä»¶
- \`bootloader.bin\` - å¼•å¯¼ç¨‹åº
- \`partition-table.bin\` - åˆ†åŒºè¡¨
- \`micropython.elf\` - è°ƒè¯•ç¬¦å·æ–‡ä»¶
- \`flash.sh\` - çƒ§å½•è„šæœ¬
- \`build-info.txt\` - æž„å»ºä¿¡æ¯

## çƒ§å½•æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨çƒ§å½•è„šæœ¬
\`\`\`bash
chmod +x flash.sh
./flash.sh /dev/ttyUSB0 460800
\`\`\`

### æ–¹æ³•2: æ‰‹åŠ¨çƒ§å½•
\`\`\`bash
# å®‰è£…esptool
pip install esptool

# æ“¦é™¤flash
esptool.py --chip esp32 --port /dev/ttyUSB0 erase_flash

# çƒ§å½•å›ºä»¶
esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 460800 write_flash -z 0x1000 firmware.bin
\`\`\`

## è¿žæŽ¥MicroPython
çƒ§å½•å®ŒæˆåŽï¼Œä½¿ç”¨ä¸²å£å·¥å…·è¿žæŽ¥ESP32:
- æ³¢ç‰¹çŽ‡: 115200
- æ•°æ®ä½: 8
- åœæ­¢ä½: 1
- æ ¡éªŒ: None

Linux/Macç¤ºä¾‹:
\`\`\`bash
screen /dev/ttyUSB0 115200
\`\`\`

Windowsç¤ºä¾‹:
ä½¿ç”¨PuTTYæˆ–è€…å…¶ä»–ä¸²å£å·¥å…·è¿žæŽ¥å¯¹åº”çš„COMç«¯å£ã€‚
EOF
        
        ls -la "$ARTIFACT_DIR/"
    
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: micropython-${{ matrix.board }}-firmware
        path: ports/esp32/artifacts-${{ matrix.board }}/
        retention-days: 30
    
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.board }}
        path: |
          ports/esp32/build-${{ matrix.board }}/build.log
          ports/esp32/build-${{ matrix.board }}/config/
        retention-days: 7

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create release archive
      run: |
        cd artifacts
        for dir in micropython-*-firmware; do
          if [ -d "$dir" ]; then
            tar -czf "${dir}.tar.gz" "$dir"
          fi
        done
        ls -la *.tar.gz
    
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: build-${{ github.run_number }}
        release_name: MicroPython ESP32 Build ${{ github.run_number }}
        body: |
          ðŸš€ **MicroPython ESP32 è‡ªåŠ¨æž„å»ºç‰ˆæœ¬**
          
          **æž„å»ºä¿¡æ¯:**
          - ESP-IDFç‰ˆæœ¬: v5.4.1
          - æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          
          **æ”¯æŒçš„å¼€å‘æ¿:**
          - ESP32_GENERIC (ESP32)
          - ESP32_GENERIC_S2 (ESP32-S2)
          - ESP32_GENERIC_S3 (ESP32-S3)
          - ESP32_GENERIC_C3 (ESP32-C3)
          - ESP32_GENERIC_C6 (ESP32-C6)
          
          **ä½¿ç”¨è¯´æ˜Ž:**
          1. ä¸‹è½½å¯¹åº”å¼€å‘æ¿çš„å›ºä»¶åŒ…
          2. è§£åŽ‹ç¼©æ–‡ä»¶
          3. è¿è¡Œ `flash.sh` è„šæœ¬çƒ§å½•å›ºä»¶
          4. æˆ–è€…æ‰‹åŠ¨ä½¿ç”¨ `esptool.py` çƒ§å½• `firmware.bin`
          
          **çƒ§å½•å‘½ä»¤:**
          ```bash
          pip install esptool
          esptool.py --chip esp32 --port /dev/ttyUSB0 erase_flash
          esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 460800 write_flash -z 0x1000 firmware.bin
          ```
        draft: false
        prerelease: false
